= DataWeave Tutorial

Learn the basics of defining DataWeave 2.0 data transformations. You often wish to change the structure of data as it moves from source to destination, and DataWeave provides a drag-n-drop interface as well as the ability to write code for complex transformations.

== Prerequisites

To enable you to focus on the workflow of a DataWeave transformation, we recommend completing a few set-up tasks.

. Navigate to  link:https://anypoint.mulesoft.com/exchange/68ef9520-24e9-4cf2-b2f5-620025690913/training-american-flights-api/[Training: American Flights API] in Exchange, and click the GET button to see a sample response in JSON:
+
image:dw-quickstart-am-json.png[]
+
This is the structure we'll transform.

. Download and install link:/anypoint-studio/v/7.2/to-download-and-install-studio[Anypoint Studio].
. Create link:https://anypoint.mulesoft.com/login/#/signin?apintent=exchange[an Anypoint Platform trial account] if you don't have one. 
. Select a REST API client such as Postman or Advanced REST client. This quickstart uses Advanced REST client.

== Step One: Create a Mule 4 Project

Although DataWeave can be specified in a few different locations, this quickstart shows you how to use DataWeave in a Mule 4 app. Let's create the project that will contain your app.

. Open Anypoint Studio, and select **File > New > Mule Project**.
. Set the **Project Name** to `training4-american-ws`, leave all other defaults, and select **Finish** to create the project.

When you're done, look in the **Package Explorer** window to see the contents of your new project.

image:dw-quickstart-package-explorer.png[]

== Step Two: Create and Configure a Mule 4 App

Now we'll add the elements required to fetch data from an API and transform it into a different structure using DataWeave.

. Create an HTTP connector that will listen to the American Flights API. In the Mule Palette, select HTTP to display the HTTP module operations, and drag the Listener operation onto the canvas.
+
image:dw-quickstart-listener.png[]
+
If you can't see anything in the Mule Palette, open the project file `training4-american-ws.xml` in the `src/main/mule` folder in Package Explorer.

. Double-click the Listener operation to display its properties tab, and click the green plus sign to add a new configuration.
+
image:dw-quickstart-listener-properties.png[]
. In the HTTP Listener config dialog, add these values:
+
** Host: 0.0.0.0
** Port: 8081
. Click **OK** to save these changes and close the dialog.
. In the Listener properties tab, change the **Path:** field to `/flights`. Your change is automatically saved.
+
image:dw-quickstart-path.png[]
. In the Mule Palette, select **Add Modules** to display a list of modules and connectors, and drag the Database connector into the left side of the Mule Palette.
+
image:dw-quickstart-add-db1.png[]
. Now that the Database connector is in the Mule Palette, you can see its operations. Drag the Select operation into the flow.
+
image:dw-quickstart-add-db2.png[]
. Let's configure the Database operation to listen for responses from the Mulesoft sample MySQL database. Choose the Select operator to display its properties tab, and click the add button (green cross) to open the Database Config dialog. 
. Select or type Mule's sample database values in the dialog:
+
** Connection: `MySQL Connection`
** Host: `iltdb.learn.mulesoft.com`
** Port: `3306`
** User: `tbd`
** Password: `tbd`
** Database: `tbd`
+
image:dw-quickstart-db-values.png[]
. While still in the Database Config dialog, select **Modify dependency** next to **MySQL JDBC Driver**. If you repeat this step, select **Configure > Add Maven dependency**.
. In the **Pick a Maven dependency** dialog, enter `mysql-` in the **Search Maven Central** search field.
. Select `mysql:mysql-connector-java` from the displayed items.
+
** image:dw-quickstart-maven1.png[]
. Select **Finish** to return to the Database Config dialog.
. Select **Test Connection**. You should receive a `Test connection successful` message. If you don't, go back through the steps and look for errors.
. Select **OK** to return to the Database Config dialog.
. Create a query that returns all flights from the Training: American Flights API.
.. If it's not already open, double-click on the Select operation to display its property tab.
.. Add a select statement in the query field: `SELECT * FROM american`. Your changes are automatically saved.
+
image:dw-quickstart-select-query.png[]
. To test your configuration so far, run the project. You can right-click in the canvas where the flow is defined, and select **Run Project training-american-ws**.
. Watch the Console tab and when the app is running, open your favorite REST API client.
. In the client, send a request to link:http://localhost:8081/flights/[http://localhost:8081/flights/]. You should see a Mule object in the result.
+
image:dw-quickstart-object.png[]

Now that the app is set up, it's time to transform some data into JSON so it can be consumed by a service that requires JSON.

[HINT]
Leave the Mule app running to avoid accidentally creating an orphan process that might clog the port specified in your app.

== Create and Test a DataWeave Data Transformation

Now that we have a Mule app that works and is listening to the Training: American Flights API, we'll add a transform module and use the DataWeave drag-n-drop interface to define a transformation from Mule object into JSON.

. In the Mule Palette, select Core and find the Transform Message component.
+
image:dw-quickstart-add-transform.png[]
. Drag and drop the Transform Message to the right of the Select operation in the canvas.
+
image:dw-quickstart-canvas.png[]
. Double-click the Transform Message component to display the DataWeave transform palette.
+
image:dw-quickstart-dw-palette.png[]
+
** The left panel shows payload data as it is delivered in the Mule object from Training: American Flights API.
** The center panel will show the relationships once you create them to the output,
** The right panel is where you define metadata for the output. 
** The right-most pane shows the DataWeave code corresponding to the transformations you specify in the drag-n-drop interface to the left.
. In the right-most pane, change the output type in line 2 from `application/java` to `application/json`, and replace the brackets on lines 4 and 5 with `payload`.
. Save the change to redeploy the project.
. Test this change by sending a GET request in your REST client: `GET http://localhost:8081/flights`. 
+
image:dw-quickstart-json1.png[]
+
With just two words in a DataWeave script, you've transformed a Mule object into JSON. Now we'll map the existing data from the API to a data structure based on an example we provide. This example represents how a second service needs to consume the data from Training: American Flights API.
. In the Transform Message pane with the Output search bar, select **Define metadata** to open the **Select metadata type** dialog.
. Select **Add** to open the **Create new type** dialog.
. Enter `american_flights_json` and select **Create type**.
. In the **Select metadata type** dialog, set the type to **JSON**.
. In the drop-down below Type, change **Schema** to **Example**.
. Copy and paste the following into a file you save on your local machine or environment. Name the file american-flights-example.json.
+
[source, json]
----
[{
	"ID": 1,
	"code": "ER38sd",
	"price": 400,
	"departureDate": "2016/03/20",
	"origin": "MUA",
	"destination": "SFO",
	"emptySeats": 0,
	"plane": {
		"type": "Boeing 737",
		"totalSeats": 150
	}
}, {
	"ID": 2,
	"code": "ER45if",
	"price": 345.99,
	"departureDate": "2016/02/11",
	"origin": "MUA",
	"destination": "LAX",
	"emptySeats": 52,
	"plane": {
		"type": "Boeing 777",
		"totalSeats": 300
	}
}]
----
. In the **Select metadta type** dialog, click the button with three dots to navigate to the file you just created and select it.
+
image:dw-quickstart-json-example2.png[]
. Choose **Select** to save your change. Now you see the input and output data structures in the DataWeave interface.
+
image:dw-quickstart-input-output.png[]
. Let's start mapping fields to create the transformation.
+ 
** Map fields with the same name by dragging them from the input section to the output section:
*** `ID`
*** `price`
*** `totalSeats`
+
Notice the DataWeave code being written in the right-most pane as you drag and drop.
+
image:dw-quickstart-same-names.png[]
. Map the rest of the data:
+
** `oAirport` to `destination`
** `takeOffDate` to `departureDate`
** `fromAirport` to `origin`
** `seatsAvailable` to `emptySeats`
** `planeType` to `type`
** Drag both `code1` and `code2` to `code`
+
Notice the DataWeave code generated as you drag and drop fields to create the transformation.
. Let's add some sample data to make the transformation results more realistic. (You can skip this step if you wish). Select **Preview** over the right-most pane, then click the link **Create required sample data to execute preview**.
+
image:dw-quickstart-sample-data1.png[]
. In the Input pane on the left (be sure to select the **payload** tab), replace all the question marks with data. Those values should also show up in the Output pane. Choose **File > Save All** from the Studio main menu.
. We've finished defining the transformation, now let's test it. Assuming that you've left the Mule app running as suggested earlier, open your REST client and send another request to the API: `GET http://localhost:8081/flights`
+
image:dw-quickstart-transformed.png[]
Notice that the data is structured as described in the Output pane, instead of following the Input pane structure as we saw in an earlier query. 

Now that you've succeeded in transforming data from Mule object to JSON, and from one data structure to another, you're ready to explore more link:/mule4-user-guide/v/4.1/dataweave[DataWeave features]. 