= Migrating Mule 3 Apps to Mule 4

//TODO: FOR GA, REMOVE *Beta* FROM GA VERSION
*Beta Release: Migration Tool and Compatibility Module*

//TODO: FOR GA, REPLACE "is a command-line utility that"...
//"is a part of Studio that"
Instead of performing a completely manual migration, you can use the Migration
tool (migrator) to automate the initial migration step for supported component, connector, and module configurations. The migrator runs a sequence of tasks
over a Mule 3 project and outputs a Mule 4 project with a report about what
remains to migrate. The output project is designed to work with a <<compatibility_module, Compatibility module>> in Studio for some important
items that are not migrated automatically by the tool.

The migration process is a multi-part task, where you:

. <<migrate_project, Run the migrator>> on a Mule 3 project, and review the <<migration_report, Migration Report>>.
. Import the migrator output into a supported version of <<min_reqs, Studio 7>>.
. Perform a manual migration for areas that the migrator does not migrate, and
use the Compatibility module on that project, as needed.

[[min_reqs]]
== Requirements

Minimum requirements:

* Studio 7.2 (with support for Mule Runtime 4.1.3 or above).

The tool migrates Mule apps that use these versions of the Mule runtime:

* 3.9.x
* 3.8.x

The tool can be used for the following versions but will not be supported in the Beta or GA:

* 3.7.x
* 3.6.x

If you run the Migration tool on these unsupported apps, the migrated output
might be less comprehensive than with supported apps.


[[supported_migrations]]
== Supported Migrations

//TODO: FOR GA, REMOVE NOTE AND REVISE CONTENT, AS NEEDED
*Note on the Beta release*: This list applies to the Beta and will expand over
time.

The Migration tool supports the following migrations:

* Mule apps only (no domains or policies supported)
* MEL to DatWeave expressions (simple cases only)
* DataWeave component to `ee:transform` (DataWeave 1.0 to DataWeave 2.0)
* Connectors: HTTP, DB, WebService Consumer
* Modules: Validations
* Transports: HTTP, JMS, File, VM (request-reply not supported)
* Components: Cache, Batch, ForEach, Choice, ScatterGather, Poll
* Error Handling, Transactional scope
* Properties and secure properties
* Spring Beans definitions
* MUnit tests
* ApiKit

Note that the <<compatibility_module, Compatibility module>> supports some
additional items until you can migrate them.

[[migrate_project]]
== Migrating a Project

//TODO: FOR GA, REMOVE NOTE AND REVISE CONTENT TO DESCRIBE STUDIO WORKFLOW
*Note on the Beta release*: For the Beta release, the migrator is a command-line
utility (packaged as an executable JAR file). After the Beta program, the
Migration tool will be released as part of Studio. You will then be able to
perform migrations through Studio, rather than from the command line.

//TODO: GET A JAR NAME THAT IS MORE LIKE WHAT CUSTOMERS WILL SEE
//TODO: LINK OUT TO STUDIO IMPORT STEPS.
To run the Migration tool:

. Make sure that the required software is installed (see <<min_reqs, Requirements>>).
. In your console, provide a command that specifies all the required <<options>>,
for example:
+
.Command-line Invocation
[source,console,linenums]
----
$ java -jar
mule-migration-tool-runner-1.0.0-20180806.163412-176-jar-with-dependencies.jar
-projectBasePath /Users/me/AnypointStudio/v6/migrator/my-v6-project
-muleVersion 4.1.3
-destinationProjectBasePath /Users/me/my_dir/my_migrated_project
----
+
If the migrator runs successfully, you will see a message something like this:
+
.Successful Migration
[source,console,linenums]
----
Executing migration...
...
===========================================================================
MIGRATION SUCCESS
===========================================================================
Total time: 11.335 s
Migration report:
/Users/me/my_dir/my_migrated_project/report/summary.html
----
. Import the project to a supported version of Studio.
+
In Studio, you can import the project by going to File -> Import, then from the dialog that opens, Anypoint Studio -> Anypoint Studio Project from File System.
+
. Open and check the Migration report (`summary.html`) at the provided URL.
+
You can find all errors and warnings in the <<migration_report>>.
+
It is important to note that the same information is provided as comments in the Mule Configuration files.
+
. Address the errors and warnings in the report.
+
Note that the <<compatibility_module, Compatibility module>> is likely work
around some of these issues until your team and address them with permanent fixes.
+
. Identify and consider additional migration steps where the automated migration
can be improved. See link:migration-manual[Migration to Mule 4: Recommended Migration Tasks].

[[compatibility_module]]
== Compatibility Module

Studio automatically applies the Compatibility module to your migrated project.

*Important:* MuleSoft recommends that you migrate to a point where the
Compatibility module can be dropped from your app and that you simply use the
module as a bridge until you or your team can do so.

The Compatibility does not cover every migration gap. The module simply
complements of the Migration tool:

 * By providing MEL support for the cases where a MEL expression could not be
 migrated to DW automatically.
 * By adapting the Mule 3 message model to Mule 4.

You or your team will need to handle other migration gaps that are covered in
the <<migration_report, Migration report>>.


//TODO: FROM RODRO: we want them to migrate to a point where the compatibility plugin can be dropped from an app

//TODO: QUESTION: WILL THEY ASK PEOPLE IF THEY WANT TO MIGRATE CASES WHERE BEST PRACTICES ARE NOT FOLLOWED?


//TODO: QUESTION: API for the tool? Tool consists of an execution engine,
//a proprietary API to allow extensions of it, and a reporting framework.

//* Task: A set of steps.
//* Step: An operation that changes, removes, or updates a resource or content
//in a Mule project.

[[migration_report]]
== Migration Report

After migrating a project, the tool produces a Migration report that you can
use to identify and perform any manual migration tasks that remain. When the
tool detects something it cannot migrate, it provides feedback about the problem
and links to information about the steps you need to take. The tool also comments
on and provides guidance for any cases that the tool is able to migrate without
following the best practices.

Inside each migrated project, the migration tool generates a report that contains
a list of migration errors and warnings, for example:

image::migrator-report.png[Mule Migration Tool Report]

* Warning (`WARN`): Identifies what you need to migrate manually even though the behavior is the same in Mule 4.
* Error (`ERROR`): Identifies something that behaves differently than its Mule 3 counterpart.

[[message_types]]
In the Configuration XML file for the project, you see any `WARN` or `ERROR`
notices. For example, see the `Migration WARN:` messages and links in the
migrated Choice router:

[source,XML,linenums]
----
<choice doc:name="Choice">
  <when expression="#[mel:flowVars.operation == 0]">
    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!--  https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->
    <flow-ref name="initialize-record" doc:name="initialize-record" />
  </when>
  <when expression="#[mel:flowVars.operation == 10]">
    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- * https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!-- * https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->
    <flow-ref name="create-api-designer-project"
      doc:name="create-api-designer-project" />
  </when>
  <otherwise>
    <logger message="#[&quot;Migration process - Migration finished - apiId:
      $(mel:payload != empty? payload[0].apiId) - apiName: $(mel:payload != empty?
      payload[0].apiName) - first apiVersion: $(mel:payload != empty?
      payload[0].apiVersion) - payload: $(payload)&quot;]"
    level="INFO" doc:name="Migration Finished">
    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!-- https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->

    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!--  https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->

    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!--  https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->
    </logger>
  </otherwise>
</choice>
----

The Migration report links to information on any post-migration steps you need to perform, for example:

image::migrator-issue-found.png[Mule Migration Tool Report - Issue Found]

[[options]]
== Command-line Options

The migrator is a command-line tool. You simply input a Mule 3 project and
output the results.

.Command-line Options
|===
| `-destinationProjectBasePath <arg>` | Required. Directory for the migrated project.
| `-help` | For displaying the help.
| `-muleVersion <arg>` | Required. The Mule version to which you are migrating: `4.1.3`.
| `-projectBasePath <arg>` a| Required. Directory of the project to to migrate.

To discover the path to your Mule 3 project from Studio, you can go to
File -> Switch Workspace -> Other..., copy the path that appears in
the Workspace field. You need to append the name of your project
to that path when you use it as the `<arg>` to `-projectBasePath`, for
example: `-projectBasePath /Users/me/AnypointStudio/v6/migrator/my-v6-project`
|===

Whenever the tool adds an entry to the report (either error or warning), the same information is also added as a comment in the Configuration XML file for the
project.

== See Also

link:migration-manual[Migration to Mule 4: Recommended Post-Migration Tasks]

////
MY NOTES: REPLACED WITH ANOTHER SECTION ABOVE
== Supported Migrations

The tool attempts to migrate these components, modules, and connectors:

* VM connector and components
* HTTP Transport (Mule 3) to HTTP connector (Mule 4)
* File Transport (Mule 3) to File connector (Mule 4)
* All (Mule 3) to Scatter-Gather component (Mule 4)
* Choice router
* For Each router
* Transform component
* Scripting module
* Cache scope
* Batch scope
* Web Service Consumer connector
* Spring module
* Poll component (Mule 3) to Scheduler
* Validation components
* Database connector

In addition, the following migrations take place:

* `outboundProperties` to `vars`
* Enrichers to Target Variables
* Secure properties and placeholders
* Inbound properties?

IN PROGRESS:

* JMS components
* All (Mule 3) to Scatter-Gather component (Mule 4)??

TODOS:

* Email
* Oauth
* XML module
* gzip?
* splitter + aggregators
* watermark
* Sockets
* FTP
* ALWAYS_BEGIN tx config in outbound endpoints
* WebSphere MQ Connector https://www.mulesoft.org/jira/browse/MMT-202
* properties files declared inside src/main/app.https://www.mulesoft.org/jira/browse/MMT-200
* Security module
* Fully migrate properties/sessionVars to variables
* Review idempotent-redelivery-policy cases
* CXF?
* JSON module
* first succ/until succ/async/flow
* Filters
* Domains


Module migrations include:

//NEW OR IN ANALYSIS on Aha:
* !!! Migration Tool Beta... !!!
* Use of the Mule 3 transport in Mule 4: JMS, File, SFTP, VM, FTP, HTTP, SSL, TCP,
* DataWeave transformations
* Migrate Mule 3 connectors to Mule 4: DB,
* Scripting module
* Mule 3 Gateway proxies to Mule 4
* ExtensionModel for compatibility plugin

//READY TO START on Aha:
* Batch jobs from Mule 3 to Mule 4
* Poll and Watermark from Mule 3 to Mule 4
* Compatibility modules for filters, transformers, components

* Adding the corresponding module to the POM (if not already added)
* Adding the necessary namespace definitions on the XML prologs (if not already added)

* Poll (`<poll/>`) replaced by Scheduler (`<scheduler/>`)
** Any `<processor-chain/>` element removed
** Cron expressions migrated
* Watermark
** If `updateExpression` is present and value is MEL, expression requires manual migration or compatibility module.
* Batch
* Legacy scopes (inbound, outbound, session) handled by new component to the compatibility module: `<ee:dump-legacy-properties />`

*
* Error Handlers
* Component bindings, Custom Components and Callable not migrated. Mule SDK.
* Secure Properties Placeholders
* Reconnection strategies: https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-patterns-reconnection-strategies
* Threading profiles removed, except for Batch
* Transactional Scope replaced with Try.
* Processing strategies removed.
* Custom Components not migrated. Mule SDK.
* Filters
* Object Store
* Message properties
* HTTP

Caveats:

Tool makes best effort to migrate MEL expressions, but when the automatic migration is not possible:

* MEL Expression migration to DW can happen before or after running the tool. Resorting to MEL means:
** Adding the compatibility module
** Adding the `mel:` prefix to the expression

_TODO: NOT INITIAL GA_
* API Manager:
* Proxy apps: For each defined proxy, should have a “Migrate to Mule 4” button which triggers the Migration tool. The tool will attempt to migrate the proxy and all the policies inside.
* Policies

If the migration is successful (no errors, but warning allowed), the user should get the chance to deploy the migrated proxy to a testing environment to verify it. If the validation succeeded, the migrated proxy should continue the standard promotion process.

If errors were found, then the user should be notified and able to download the migrated project. He can then import that project in Studio and access the migration report to take corrective action.
////
