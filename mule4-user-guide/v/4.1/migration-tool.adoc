= Migrating Mule 3 Apps to Mule 4

//TODO: FOR GA, REMOVE *Beta* FROM GA VERSION
*Beta Release: Migration Tool and Compatibility Module*

The Migration tool (migrator) automates the migration of Mule 3 applications to
Mule 4. Although it will not migrate the application entirely, the tool will be of
great help regarding:

* Migrating the project structure
* Automatically creating descriptor files, such as `pom.xml` or `mule-artifact.json`
* Automatically performing a great number of adaptations in the application's code
* Provide guidance on how to manually deal with components and patterns which cannot be automatically migrated

Although the migrator will help with the heavy lifting, it's not to be expected to deliver a fully functional application. Some additional steps will be required. Those steps will include testing and may also include:

* Manual migration of unsupported components
* Manual migration of complex DataWeave transformations
* Manual migration of DataMapper transformations

== About the Migration Process

The migration process is a multi-part procedure, where you:

. Run the migrator on a Mule 3 project.
. Import the migrator output into a supported version of Studio 7.
. Review the Migration report.
. Perform a manual migration on what the migrator does not migrate.
. Remove uses of Compatibility module components.

These steps are detailed in <<migrate_project, Migrating a Project>>.

[[min_reqs]]
== Requirements

Minimum requirements for a migrated app:

* Studio 7.2 (with support for Mule Runtime 4.1.3 or above).

The tool migrates Mule apps that use these versions of the Mule runtime:

* 3.9.x
* 3.8.x

// TODO: REMOVE BETA INFO AT GA?
*For the Beta:*
You can also try out the migrator on Mule apps that run on these earlier Mule Runtime versions, but please note these versions are not supported for the
Beta or at GA:

* 3.7.x
* 3.6.x

Also note that if you run the migrator on apps that use unsupported versions, the migrated output might be less comprehensive than with supported ones.

[[supported_migrations]]
== Supported Migrations

//TODO: FOR GA, REMOVE NOTE AND REVISE CONTENT, AS NEEDED
*Note on the Beta release*: This list applies to the Beta and will expand over
time.

The Migration tool supports the following migrations:

* Mule apps only (no domains or policies are supported)
* MEL to DataWeave expressions (simple cases only)
* DataWeave component to `ee:transform` (DataWeave 1.0 to DataWeave 2.0)
* Connectors: HTTP, Database, Web Service Consumer
* Modules: Validations, Scripting (DSL only, no migration of the script itself)
* Transports: HTTP, JMS, File, VM (request-reply not supported)
* Components: Cache, Batch, For Each, Choice, Scatter-Gather, Poll
* Error Handling, Transactional scope
* Properties and secure properties
* Spring Beans definitions
* MUnit tests
* ApiKit

Note that the <<compatibility_module, Compatibility module>> supports some
additional items from Mule 3.x until you can migrate them:

* `set-property`
* `remove-property`
* `copy-properties`
* `set-session-variable`
* `remove-session-variable`

== Unsupported Migrations

//TODO: FOR GA, REMOVE NOTE AND REVISE CONTENT, AS NEEDED
*Note on the Beta release*: This list applies to the Beta and will expand over
time.

The Migration tool does not support the following migrations:

* Custom Java code, either used directly or through any of the following:
** `<custom-transformer>`
** `<custom-message-processor>`
** `<component`
** `<pooled-component>`
** `<invoke>`
** Anything that implements the `org.mule.api.lifecycle.Callable` interface
** etc.
* DataMapper

== Custom Devkit components

Applications might also contain custom made Devkit connectors. The migrator will obviously not be able to
migrate those, but remember that a link:mule-sdk/v/1.1/dmt[Devkit migration tool] is also available to convert those Devkit projects
to Mule 4 SDK ones. After the components have been migrated, you will then have to:

* Manually add the migrated modules to the application's `pom.xml`
* Manually adapt all the uses of such components

[[migrate_project]]
== Migrating a Project

//TODO: FOR GA, REMOVE NOTE AND REVISE CONTENT TO DESCRIBE STUDIO WORKFLOW
*Note on the Beta release*: For the Beta release, the migrator is a command-line
utility (packaged as an executable JAR file). After the Beta program, the
Migration tool will be released as part of Studio. You will then be able to
perform migrations through Studio, rather than from the command line.

//TODO: GET A JAR NAME THAT IS MORE LIKE WHAT CUSTOMERS WILL SEE
//TODO: LINK OUT TO STUDIO IMPORT STEPS.
To run the Migration tool:

. Make sure that the required software is installed (see <<min_reqs, Requirements>>).
. In your console, provide a command that specifies all the required <<options>>,
for example:
+
.Command-line Invocation
[source,console,linenums]
----
$ java -jar mule-migration-tool-runner-0.1.0.jar
 -projectBasePath /Users/me/AnypointStudio/v6/migrator/my-v6-project
 -muleVersion 4.1.3
 -destinationProjectBasePath /Users/me/my-dir/my-migrated-project
----
+
If the migrator runs successfully, you will see a message something like this:
+
.Successful Migration
[source,console,linenums]
----
Executing migration...
...
========================================================
MIGRATION SUCCESS
========================================================
Total time: 11.335 s
Migration report:
/Users/me/my-dir/my-migrated-project/report/summary.html
----
+
. Import the project to a supported version of Studio (see <<min_reqs, Requirements>>).
+
In Studio, you can import the project by going to File -> Import, then from the
dialog that opens, Anypoint Studio -> Anypoint Studio Project from File System.
+
. Open and check the Migration report (`summary.html`) at the path provided in
the console output.
+
You can find all errors and warnings in the <<migration_report>>.
+
It is important to note that the same information is provided as comments in
the Mule Configuration XML files for your project that the Migration tool outputs.
+
. Address the errors and warnings in the report.
+
Note that the <<compatibility_module, Compatibility module>> is likely to work
around some of these issues until you or your team can address them with
permanent fixes.
+
. Identify and consider additional migration steps where the automated migration
by the tool can be improved. See
link:migration-manual[Migration to Mule 4: Recommended Migration Tasks].
+
This step includes removing Compatibility module components from the project XML.

[[compatibility_module]]
== Compatibility Module

Some components or patterns cannot be automatically migrated by just transforming the application's
XML. For such cases, the migrator adds the Compatibility module to your project. The Compatibility Module
is a set of components which either adapt Mule 3 components into the Mule 4 architecture, or in some cases,
even allows to run some Mule 3 components in Mule 4.

*Important:* MuleSoft recommends that you migrate to a point where the
Compatibility module can be dropped from your app and that you simply use the
module as a bridge until the manual steps of the migration are complete.

The Compatibility does not cover every migration gap. The module simply
complements the Migration tool:

 * By providing MEL support for the cases where a MEL expression could not be
 migrated to DataWeave automatically.
 * By adapting the Mule 3 message model to Mule 4.

You or your team will need to handle other migration gaps that are covered in
the <<migration_report, Migration report>>.

//TODO: QUESTION: API for the tool? Tool consists of an execution engine,
//a proprietary API to allow extensions of it, and a reporting framework.

[[migration_report]]
== Migration Report

After migrating a project, the tool produces a Migration report that you can
use to identify and perform any manual migration tasks that remain. When the
tool detects something it cannot migrate, it provides feedback about the problem
and links to information about the steps you need to take. The tool also comments
on and provides guidance for any cases that the tool is able to migrate without
following the best practices.

Inside each migrated project, the migration tool generates a report that contains
a list of migration errors and warnings, for example:

image::migrator-report.png[Mule Migration Tool Report]

* Warning (`WARN`): For these issues, the Compatibility module can serve as a
temporary workaround until you migrate them manually.
* Error (`ERROR`): Issues that require a manual migration. There is no
workaround through the Compatibility module.

[[message_types]]
In the Configuration XML file for the output project, you see any `WARN` or `ERROR`
notices. For example, see the `Migration WARN:` messages and links in the
migrated Choice router:

[source,XML,linenums]
----
<choice doc:name="Choice">
  <when expression="#[mel:flowVars.operation == 0]">
    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!--  https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->
    <flow-ref name="initialize-record" doc:name="initialize-record" />
  </when>
  <when expression="#[mel:flowVars.operation == 10]">
    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- * https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!-- * https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->
    <flow-ref name="create-api-designer-project"
      doc:name="create-api-designer-project" />
  </when>
  <otherwise>
    <logger message="#[&quot;Migration process - Migration finished - apiId:
      $(mel:payload != empty? payload[0].apiId) - apiName: $(mel:payload != empty?
      payload[0].apiName) - first apiVersion: $(mel:payload != empty?
      payload[0].apiVersion) - payload: $(payload)&quot;]"
    level="INFO" doc:name="Migration Finished">
    <!--Migration WARN: MEL expression could not be migrated to a DataWeave expression-->
    <!-- For more information refer to:-->
    <!-- https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-mel-->
    <!-- https://blogs.mulesoft.com/dev/mule-dev/why-dataweave-main-expression-language-mule-4/-->
    </logger>
  </otherwise>
</choice>
----

The Migration report links to information on any post-migration steps you need to perform, for example:

image::migrator-issue-found.png[Mule Migration Tool Report - Issue Found]

[[options]]
== Command-line Options

The migrator is a command-line tool. You simply input a Mule 3 project and target version and then output the results.

.Command-line Options
|===
| `-destinationProjectBasePath <arg>` | Required. Directory for the migrated project.
| `-help` | For displaying the help.
| `-muleVersion <arg>` | Required. The Mule version to which you are migrating: `4.1.3`.
| `-projectBasePath <arg>` a| Required. Directory of the project to to migrate.

To discover the path to your Mule 3 project from Studio, you can go to
File -> Switch Workspace -> Other..., copy the path that appears in
the Workspace field. You need to append the name of your project
to that path when you use it as the `<arg>` to `-projectBasePath`, for
example: `-projectBasePath /Users/me/AnypointStudio/v6/migrator/my-v6-project`
|===

Whenever the tool adds an entry to the report (either error or warning), the same information is also added as a comment in the Configuration XML file for the
project.

== See Also

link:migration-manual[Migration to Mule 4: Recommended Post-Migration Tasks]

////
MY NOTES: REPLACED WITH ANOTHER SECTION ABOVE
== Supported Migrations

The tool attempts to migrate these components, modules, and connectors:

* VM connector and components
* HTTP Transport (Mule 3) to HTTP connector (Mule 4)
* File Transport (Mule 3) to File connector (Mule 4)
* All (Mule 3) to Scatter-Gather component (Mule 4)
* Choice router
* For Each router
* Transform component
* Scripting module
* Cache scope
* Batch scope
* Web Service Consumer connector
* Spring module
* Poll component (Mule 3) to Scheduler
* Validation components
* Database connector

In addition, the following migrations take place:

* `outboundProperties` to `vars`
* Enrichers to Target Variables
* Secure properties and placeholders
* Inbound properties?

IN PROGRESS:

* JMS components
* All (Mule 3) to Scatter-Gather component (Mule 4)??

TODOS:

* Email
* Oauth
* XML module
* gzip?
* splitter + aggregators
* watermark
* Sockets
* FTP
* ALWAYS_BEGIN tx config in outbound endpoints
* WebSphere MQ Connector https://www.mulesoft.org/jira/browse/MMT-202
* properties files declared inside src/main/app.https://www.mulesoft.org/jira/browse/MMT-200
* Security module
* Fully migrate properties/sessionVars to variables
* Review idempotent-redelivery-policy cases
* CXF?
* JSON module
* first succ/until succ/async/flow
* Filters
* Domains


Module migrations include:

//NEW OR IN ANALYSIS on Aha:
* !!! Migration Tool Beta... !!!
* Use of the Mule 3 transport in Mule 4: JMS, File, SFTP, VM, FTP, HTTP, SSL, TCP,
* DataWeave transformations
* Migrate Mule 3 connectors to Mule 4: DB,
* Scripting module
* Mule 3 Gateway proxies to Mule 4
* ExtensionModel for compatibility plugin

//READY TO START on Aha:
* Batch jobs from Mule 3 to Mule 4
* Poll and Watermark from Mule 3 to Mule 4
* Compatibility modules for filters, transformers, components

* Adding the corresponding module to the POM (if not already added)
* Adding the necessary namespace definitions on the XML prologs (if not already added)

* Poll (`<poll/>`) replaced by Scheduler (`<scheduler/>`)
** Any `<processor-chain/>` element removed
** Cron expressions migrated
* Watermark
** If `updateExpression` is present and value is MEL, expression requires manual migration or compatibility module.
* Batch
* Legacy scopes (inbound, outbound, session) handled by new component to the compatibility module: `<ee:dump-legacy-properties />`

*
* Error Handlers
* Component bindings, Custom Components and Callable not migrated. Mule SDK.
* Secure Properties Placeholders
* Reconnection strategies: https://docs.mulesoft.com/mule4-user-guide/v/4.1/migration-patterns-reconnection-strategies
* Threading profiles removed, except for Batch
* Transactional Scope replaced with Try.
* Processing strategies removed.
* Custom Components not migrated. Mule SDK.
* Filters
* Object Store
* Message properties
* HTTP

Caveats:

Tool makes best effort to migrate MEL expressions, but when the automatic migration is not possible:

* MEL Expression migration to DataWeave can happen before or after running the tool. Resorting to MEL means:
** Adding the compatibility module
** Adding the `mel:` prefix to the expression

_TODO: NOT INITIAL GA_
* API Manager:
* Proxy apps: For each defined proxy, should have a “Migrate to Mule 4” button which triggers the Migration tool. The tool will attempt to migrate the proxy and all the policies inside.
* Policies

If the migration is successful (no errors, but warning allowed), the user should get the chance to deploy the migrated proxy to a testing environment to verify it. If the validation succeeded, the migrated proxy should continue the standard promotion process.

If errors were found, then the user should be notified and able to download the migrated project. He can then import that project in Studio and access the migration report to take corrective action.
////
