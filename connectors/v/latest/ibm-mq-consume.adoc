= To Consume IBM MQ Messages
:keywords: jms, connector, consume, message
:toc:
:toc-title:

The Consume operation in the IBM MQ connector provides the ability to consume a
Message at any given time of the flow, from any given Destination.

== Consuming A Message
The syntax to consume a message from a Queue is:

[source, xml, linenums]
----
<ibm-mq:consume config-ref="IBM_MQ_config" destination="#[vars.destination]"/>
----

The operation above consumes the first available message in the Queue identified
by the destination, and then converts it to a `MuleMessage` resulting in the
following structure:

* The message's content as payload.
* The message's metadata in the message attributes.

Once received, the Message will be immediately acknowledged by default. If you
want to control the ACK of the Message after some processing, then `ackMode`
should be set to `MANUAL`
For more information regarding a Message ACK, check the link:ibm-mq-ack[How To Handle Message Acknowledgement].

== Waiting for a Message

By default, the maximum wait time is configured in 10 seconds, producing a
`IBM-MQ:TIMEOUT` error if no message is available in that period.
In order to configure a timeout that fits better your use case, customize the
`maximumWait` and `maximumWaitUnit` parameters.

In order to wait indefinitely for a Message to arrive, the `maximumWait` value
has to be set to `-1`. In this case, no `TIMEOUT` error will be thrown.

== Filtering Incoming messages

The IBM MQ Connector provides full support for filtering which Messages should
be consumed based on the standard *JMS selector language*.

For example, if you have a priority Queue with Messages that need to be processed
faster than the others, we can do:

[source, xml, linenums]
----
<ibm-mq:consume config-ref="IBM_MQ_config" destination="openTickets" selector="JMSPriority=8"/>
----

When a selector is configured, only the Messages matching it will be received,
ignoring if any other Message is in the destination.

== Mime Types and Encoding

The IBM MQ Connector does its best to auto determine a Message’s mime type
(`contentType`) based on the `MM_MESSAGE_CONTENT_TYPE` property. However, there
are cases in which that best guess is not enough, and you need first-hand knowledge of the Message’s content.

In such cases, you can force that content type to a particular value by using
the `contentType` parameter.

The same process works for encoding. By default, the connector will assume that
the runtime’s default encoding matches the one in the Message if no other
information is provided. You can set this by using the `encoding` parameter.

WARNING: This mime type propagation will work only when the IBM MQ Target Client is selected on `JMS_COMPLIANT`.

== Consuming A Message Using Topic Subscriptions

Consuming messages from a Topic destination is very similar to consuming them
from a Queue, but with the extra functionality of being able to use Topic
subscriptions to share state between consumers.
The syntax for consuming messages from a Topic is:

[source, xml, linenums]
----
<ibm-mq:consume config-ref="IBM_MQ_config" destination="#[vars.destination]">
    <ibm-mq:consumer-type>
        <ibm-mq:topic-consumer/>
    </ibm-mq:consumer-type>
</ibm-mq:consume>
----

All the `consume` operation parameters remain the same, but now you can handle
the subscription configuration in the `topic-consumer` parameter.

For details on how to configure the Topic subscriptions go to link:ibm-mq-topic-subscription[Using Topic Subscriptions].


== Incoming Message Metadata

As stated before, each Message received will consist of two parts:

* The payload, containing the content of the Message
* The attributes, containing metadata regarding the Message

This Metadata has three parts that map all the information available in a JMS Message:

* AckId
* Headers
* Properties

Check the link:ibm-mq-documentation[JMS Reference] for details regarding the Attributes structure.

== See Also

* link:ibm-mq-topic-subscription[Using Topic Subscriptions]
* link:ibm-mq-listener[To Listen For New Messages]
