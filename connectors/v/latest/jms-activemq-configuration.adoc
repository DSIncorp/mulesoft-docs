= Configuring an ActiveMQ Connection
:keywords: jms, connector, jms_1.0.2b, jms_1.1, jms_2.0, activemq

= Connecting To ActiveMQ

Support for ActiveMQ 5 is provided out of the box by the connector using the
`active-mq-connection`. With this connection, you can use both JMS 1.1 (the default)
or JMS 1.0.2b specs, and configure all the general connection parameters for JMS,
as well as the custom parameters only present in ActiveMQ.

Once we declare the `active-mq-connection`, all that's left to do is set up the
connection factory with our custom configuration. Every parameter in the connection
comes with a default value, meaning that you are required to configure only the
parameters relevant for your use case. Also, the ActiveMQ connection exposes
parameters that are exclusive of ActiveMQ implementation, like `initialRedeliveryDelay`.

An example of a simple configuration of an ActiveMQ connection would be:

[source, xml, linenums]
----
<jms:config name="JMS_Config">
 <jms:active-mq-connection >
  <jms:factory-configuration brokerUrl="tcp://localhost:61616" />
 </jms:active-mq-connection>
</jms:config>
----
[[on-memory-broker]]
== On Memory Broker

By default the ActiveMQ Connector uses a On Memory Broker, this make
easy to start building an application without needing to configure a connection
against a external broker.

Default URL: `vm://localhost?broker.persistent=false&broker.useJmx=false`

To make usage of On Memory Broker is required to configure both <<activemq-client-lib,ActiveMQ Client>>
and <<activemq-broker-lib,ActiveMQ Broker>> libraries.

== SSL Connections

*Since JMS 1.3.0*

ActiveMQ Connections can be configured with SSL configurations, this enables
to establish secure and encrypted connections against the ActiveMQ Broker.

[source, xml, linenums]
----
<jms:config name="JMS_Config">
  <jms:active-mq-connection>
   <tls:context>
    <tls:trust-store
      path="client.ts"
      password="password" />
    <tls:key-store
      path="client.ks"
      password="password"
      keyPassword="password"
      alias="client" />
   </tls:context>
  </jms:active-mq-connection>
</jms:config>
----

image:./_images/jms-ssl.png[JMS ActiveMQ SSL Configuration]

Also the connector can reference Global TLS Context configurations, so you can
reuse and share the same TLS Context between connectors like HTTP.

[source, xml, linenums]
----
<!--  HTTP Requester Configuration -->
<http:request-config name="HTTP_Request_configuration">
  <http:request-connection tlsContext="TLS_Context" />
</http:request-config>

<!--  JMS Configuration -->
<jms:config name="JMS_Config">
  <jms:active-mq-connection tlsContext="TLS_Context"/>
</jms:config>

<!--  Reusable TLS Context -->
<tls:context name="TLS_Context">
 <tls:trust-store
  path="clien.ts"
  password="password" />
<tls:key-store
  path="client.ks"
  password="password"
  keyPassword="password"
  alias="client" />
</tls:context>
----

== Delivery Handling

[[poison-messages]]
=== Avoid Poison Messages

When a message could not be processed correctly, is not acknowledged, the message
will be redelivered again, probably not processing it correctly again and this
cycle will be executed indefinitely.

To prevent this cases, where a message is can't be handled and is redelivered constantly
forever, "Poison Messages", a Max Redelivery configuration can be done to set
a max number of times that a message can be delivered to the application.

.In this example a message will be redelivered at max 10 times.
[source, xml, linenums]
----
<jms:config name="JMS_Config">
  <jms:active-mq-connection>
    <jms:factory-configuration maxRedelivery="10"/>
  </jms:active-mq-connection>
</jms:config>
----

By Default, the JMS Connector uses a `maxRedelivery` of 0, this means that messages
won't be redelivered, doesn't matter is the message is recovered or rollbacked
from a transaction.
If the message has a persistent delivery, ActiveMQ will send the message to
the DLQ.QUEUE (Dead Letter Queue).

=== Advanced Redelivery

ActiveMQ lets users have a client side redelivery configuration, as seen, is
possible to configure the <<poison-messages,max times redelivery of a message>>
but also configure how fast is required to redeliver the message.

*initialRedeliveryDelay* : In milliseconds, how much time to wait until the message
is redelivered for the first time.
*redeliveryDelay* : In milliseconds, how much time to wait until the message
is redelivered after the first redeliver.

[source, xml, linenums]
----
<jms:config name="JMS_Config">
  <jms:active-mq-connection>
    <jms:factory-configuration
      redeliveryDelay="100"
      initialRedeliveryDelay="1000"/>
  </jms:active-mq-connection>
</jms:config>
----

== Object Serialization

Since ActiveMQ 5.12.2 and 5.13.0, ActiveMQ restrict the classes the can be serialized
and deserialized to prevent the execution malicious payload can that can exploit
the host system.

=== Trusted Packages

By default ActiveMQ only will allow the JDK/JRE provided classes, but if you
need to exchange object messages, you need to add packages your applications are
using:

[source, xml, linenums]
----
<jms:config name="JMS_Config">
  <jms:active-mq-connection>
    <jms:factory-configuration >
      <jms:trusted-packages >
        <jms:trusted-package value="com.mulesoft.someapp" />
        <jms:trusted-package value="com.mulesoft.someapp.model" />
      </jms:trusted-packages>
    </jms:factory-configuration>
  </jms:active-mq-connection>
</jms:config>
----

image:./_images/jms-trusted-packages.png[JMS ActiveMQ Trusted Packages]

In this example the JMS Connector will only allow to consume and produce ObjectMessages
compliant with the `com.mulesoft.someapp` and `com.mulesoft.someapp.model` packages.

=== Trust All Packages

Other way to enable the serialization of more classes is to enable the `trustAllPackages`
configuration, this will recover the old behavior of allowing any Object to
be serialized and deserialized. This is totally disallowed in order to prevent
malicious attacks.

[source, xml, linenums]
----
<jms:config name="JMS_Config">
  <jms:active-mq-connection>
    <jms:factory-configuration trustAllPackages="true"/>
  </jms:active-mq-connection>
</jms:config>
----

== Configuring Required Libraries

image:./_images/jms-libs.gif[Configuring Required JMS Libraries]

[[activemq-client-lib]]
=== ActiveMQ Client

The ActiveMQ Client Library is the only required to use ActiveMQ Connections, is
needed to connect agains any broker.

[source, xml, linenums]
----
<dependency>
 <groupId>org.apache.activemq</groupId>
 <artifactId>activemq-client</artifactId>
 <version>5.15.4</version>
</dependency>
----

[[activemq-broker-lib]]
=== ActiveMQ Broker

The ActiveMQ Broker is used when is required to create an <<on-memory-broker,On Memory Broker>>.

[source, xml, linenums]
----
<dependency>
 <groupId>org.apache.activemq</groupId>
 <artifactId>activemq-broker</artifactId>
 <version>5.15.4</version>
</dependency>
----

=== ActiveMQ KahaDB

The ActiveMQ KahaDB is required when using a <<on-memory-broker,On Memory Broker>>
but also is required to have persistent message delivery.

[source, xml, linenums]
----
<dependency>
 <groupId>org.apache.activemq</groupId>
 <artifactId>activemq-kahadb-store</artifactId>
 <version>5.15.4</version>
</dependency>
----

== See Also

* link:jms-consume[How Consume Messages]
* link:jms-publish[How Publish Messages]
* link:jms-listener[How Listen For New Messages]
* link:jms-publish-consume[How Listen For A Reply]
* link:jms-ack[Handling Message Acknowledgement]
* link:jms-transactions[Handling Transactions in JMS]
* link:jms-performance[JMS Tuning For Performance]
* link:jms-documentation[JMS Connector Technical Reference]
