= Anypoint MQ Connector
:imagesdir: ./_images

_Select_

Anypoint MQ Version 4.0

The Anypoint MQ connector provides publish-subscribe messaging to Mule applications in the cloud. Anypoint MQ supports a wide range of messaging use cases: enterprise messaging patterns, asynchronous communications between microservices, IoT, and more. Anypoint MQ has a REST api for publishing or consuming messages using any framework such as node.js, Java, Go, and devops bash scripts.

== Prerequisites

To use this connector, you should be familiar with Anypoint Studio, Anypoint connectors, and Mule flows. The Anypoint MQ connector is free, but connecting to the service in Anypoint Platform requires a license.

*Note:* You cannot complete the configuration information in this document without an Anypoint MQ license. Contact MuleSoft Sales for a trial license.

=== Compatibility

[%header%autowidth.spread]
|===
|Software |Version
|Mule Runtime |4.0.0 and later
|Anypoint Studio |v7 and later
|===

== Using MQ as a Trigger in Design Center

Using MQ as a trigger means that the MQ subscriber in Design Center waits 
for a message to consume. The message the trigger consumes is sent by an 
MQ connector instance running either in Anypoint Studio or 
Runtime Manager that publishes messages. The messages that MQ connector 
publishes come from either the MQ user interface in Anypoint Platform or 
from calls to the REST API.

*Notes:* 

* See link:/connectors/anypoint-mq-connector/reference[Anypoint MQ Connector Reference] for more information on Design Center fields.
* If you have an autofill application such as Last Pass, temporarily disable it before using
Design Center. Otherwise, the autofill application prevents testing the connection to MQ 
from Design Center.

=== Configuring the MQ Trigger

. In Anypoint Platform > Design Center, create a Mule Application.
. For the trigger, select *Mule Anypoint MQ Connector*:
+
image:mq-trigger-name.png[Mule Anypoint MQ Connector trigger]
+
. For the Destination, type the MQ queue name or message exchange you want to subscribe to:
+
image:mq-trigger-destination.png[Design Center Destination field]
+
. If needed, click the Redelivery tab. Max Redelivery Count sets the number of times
a message is redelivered to a queue or message exchange. This value can range from -1,
which means continually redeliver, 0 which means don't redeliver, and up to a maximum
of 10 tries to redeliver a message. Setting a value over 10 converts to 10. You can also set secure hash values or
one or more expressions to indicate when a message has been redelivered.
. If needed, click Advanced to specify a reconnection strategy for how long to wait to reconnect, and how many attempts to make to reconnect, output MIME type, output encoding for the messages you receive, 
and prefetch values. 
. Click *Set up* to specify the client ID, client secret, and region.
+
image:mq-dc-setup.png[Setup button in Design Center]
+ 
. Open an additional browser tab to Anypoint Platform > MQ.
. Copy the region from the MQ main screen, for example, `+https://mq-us-east-1.anypoint.mulesoft.com/api/v1+` (for US East Virginia) and paste the URL in the URL field in Design Center.
. Click Client Apps and get the client ID and secret for an application.
. Copy and paste the client ID and secret into the Design Center user interface. 
. In Design Center, click Test to test the connection to MQ.
. If needed, set values for Proxy and TCP Client Socket Properties. You can also configure 
TLS Context, Trust Store, Key Store, and Revocation Check from the TLS/SSL tab. The Advanced
tab lets you set reconnection and expiration policy values.
. Click Save to complete the setup.

For a complete description of each setting, defaults, and other information, see the
link:/connectors/anypoint-mq-connector-reference[Anypoint MQ Connector Reference].

=== Specifying MQ as a Component

As a Design Center component, MQ supports the Ack, Consume, Nack, and Publish operations.

The Publish operation publishes messages into queues or message exchanges. For the Consume operation, you can receive messages from a queue.

The Ack operation acknowledges a message whereupon the connector deletes it. The Nack 
operation indicates that an application doesn’t want the current message. MQ returns the message to the queue so that another application can receive the message.

The Ack and Nack operations receive an Ack Token from the connector that should not be changed. The token enables the operations to work. 

==== Publishing MQ Messages

Configure Design Center to publish MQ messages:

* Destination: The MQ queue or message exchange name to publish to.  
* Body > Payload: The content in the body of the message to publish. 

For remaining parameters, see <<Configuring the MQ Trigger>> or the
link:/connectors/anypoint-mq-connector-reference[Anypoint MQ Connector Reference].

==== Consuming MQ Messages

Configure Design Center General tab to consume MQ messages:

* Destination: The MQ queue to consume messages from.
* Acknowledgement Mode: 
** IMMEDIATE (default) - An application receives a message and the MQ connector immediately acknowledges and deletes the message.
** AUTO - The Anypoint MQ connector automatically sends an Ack or Nack at the end of a flow depending on whether the MQ connector detects a Catch Exception Strategy (ACK) or a Rollback Exception Strategy (NACK).
** MANUAL - An application indicates that it sends its own Ack or Nack using the Anypoint MQ connector local state.
* Acknowledgement Timeout - The time in milliseconds that a message is held waiting for an Ack or Nack.
* Polling Time - Time in milliseconds to wait if the requested message are not yet ready to be consumed.

For remaining parameters, see <<Configuring the MQ Trigger>> or the
link:/connectors/anypoint-mq-connector-reference[Anypoint MQ Connector Reference].

== Installing the MQ Connector in Studio

From Anypoint Exchange:

. In Anypoint Studio, click the Exchange icon in the Studio task bar.
. Click Login in Anypoint Exchange and supply your Anypoint Platform username and password.
. Search for the connector and click Install.
. Follow the prompts to install the connector.

Manually:

. Open your Mule project in Anypoint Studio.
. Add the connector as a dependency in the pom.xml file:
+
[source,xml,linenums]
----
<dependency>
  <groupId>com.mulesoft.connectors</groupId>
  <artifactId>anypoint-mq-connector</artifactId>
  <version>4.0.0</version>
  <classifier>mule-plugin</classifier>
</dependency>
----

== Configuring with the Studio Visual Editor

. In Studio, click File > New > Mule Project.
. If you want to have MQ as a subscriber at the start of a flow, drag the Subscriber operation to the canvas. 
. Alternatively, you can trigger a publish using the HTTP connector -- This lets you test MQ from a browser. If using the HTTP connector at the start of the flow, click HTTP in the Mule Palette and drag the Listener operation to the Studio canvas. Click the HTTP connector, and click the green plus sign to the right of Connector Configuration. Specify values for Host and Port, and click Test Connection to ensure HTTP works correctly on your computer. Click OK. In the HTTP properties window, set the Path to `/mq/{messageId}`.
. Click Anypoint MQ in the Mule Palette and drag an operation to the Studio canvas.
+
Possible operations are:
+
[%header%autowidth.spread]
|===
|Operation |Description
|link:/connectors/anypoint-mq-connector-reference#ack[Ack] |Indicates that the message has been consumed correctly and deletes the message from in-flight status.
|link:/connectors/anypoint-mq-connector-reference#consume[Consume] |Consumes messages from a queue.
|link:/connectors/anypoint-mq-connector-reference#nack[Nack] |Changes the status of the message from in-flight to in-queue to be consumed again by a subscriber.
|link:/connectors/anypoint-mq-connector-reference#publish[Publish] |Publishes messages
to a queue or message exchange.
|link:/connectors/anypoint-mq-connector-reference#subscriber[Subscriber] |Subscribes to 
a message source.
|===
+
For a complete list of configuration fields for each operation, see the link:/connectors/anypoint-mq-connector-reference[Anypoint MQ Connector Reference].
+
. Click the green plus sign to the right of Connector Configuration.

=== Specifying MQ Global Element Properties

image:mq-global-elements-properties.png[Global Element Properties]

. Specify the URL for the region you want your MQ queues and exchanges to reside. See
link:/anypoint-mq/[Anypoint MQ] for a list of available regions.
+
. In Anypoint Platform, click MQ > Client Apps. If needed, create a client app.
. Copy the Anypoint Platform > MQ > Client App > Client App ID value to the clipboard and paste into Studio's Client ID field.
. Copy the Client App > Client Secret value to the clipboard and paste into Studio's Client Secret field. You can ignore the other settings to test your connector.
. Click OK. 
. If using the Publish or Consume operations, specify the *Destination* as the name of the queue or message exchange that you set in Anypoint Platform.
. For the Publish operation, you can leave the Message ID field empty, or specify a message ID if you want to publish a specific message ID. If a message ID is not set, MQ auto generates a unique message ID for each message that’s sent to a queue. When publishing to FIFO queues, if you specify a Message ID and the Message ID is the same on multiple messages, the messages with the same Message ID are not redelivered.

== XML and Standalone Configuration

For a list of XML fields, see link:/connectors/anypoint-mq-connector-reference[Anypoint MQ Connector Reference].

=== MQ Schema and Endpoint

If you are creating an XML or standalone application, add this dependency to your pom.xml file:

[source,xml,linenums]
----
<dependency>
  <groupId>com.mulesoft.connectors</groupId>
  <artifactId>anypoint-mq-connector</artifactId>
  <version>4.0.0</version>
  <classifier>mule-plugin</classifier>
</dependency>
----

*Note:* If you are creating an application using Anypoint Studio, when you install the MQ connector, the MQ dependency
in the pom.xml file is updated for you.

Additional dependencies for Gradle, EBT, and Ivy are listed in Anypoint Exchange in the https://www.anypoint.mulesoft.com/exchange/org.mule.tooling.messaging/mule-module-anypoint-mq-ee-studio/[Anypoint MQ Connector] asset. Click Dependency Snippets for a complete list.

Endpoint:

`+http://www.mulesoft.org/schema/mule/anypoint-mq+`

== Example: Subscribe and Publish

The following example shows the use of an MQ Subscriber and publishing a messge:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:dw="http://www.mulesoft.org/schema/mule/ee/dw"
        xmlns:anypoint-mq="http://www.mulesoft.org/schema/mule/anypoint-mq"
        xmlns:http="http://www.mulesoft.org/schema/mule/http"
        xmlns="http://www.mulesoft.org/schema/mule/core"
        xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
        xmlns:spring="http://www.springframework.org/schema/beans"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="
http://www.mulesoft.org/schema/mule/ee/dw 
http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd 
http://www.mulesoft.org/schema/mule/ee/dw
http://www.mulesoft.org/schema/mule/ee/dw/current/dw.xsd
http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core
http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http
http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/anypoint-mq
http://www.mulesoft.org/schema/mule/anypoint-mq/current/mule-anypoint-mq.xsd">
  <anypoint-mq:default-subscriber-config name="Anypoint_MQ_Configuration"
  doc:name="Anypoint MQ Configuration">
      <anypoint-mq:connection url="https://mq-us-east-1.anypoint.mulesoft.com/api/v1"
      clientId="<id>" clientSecret="<secret>"/>
  </anypoint-mq:default-subscriber-config>
<flow name="producerFlow">
    <anypoint-mq:subscriber doc:name="Subscriber" />
    <dw:transform-message doc:name="Create Customer">
    <dw:set-payload><![CDATA[%dw 1.0
%output application/json
---
{
    "firstName" : "Polly",
    "lastName" : "Hedra",
    "company" : "Acme, Inc"
}]]></dw:set-payload>
    </dw:transform-message>
  <anypoint-mq:publish config-ref="Anypoint_MQ_Configuration"
    destination="MyExchange"
    messageId="mq42" doc:name="Anypoint MQ">
   <anypoint-mq:body>#[payload]</anypoint-mq:body>
  </anypoint-mq:publish>
</flow>
</mule>
----

== See Also

* link:/connectors/anypoint-mq-connector-reference[Anypoint MQ Connector Reference]
* https://www.anypoint.mulesoft.com/exchange/com.mulesoft.connectors/anypoint-mq-connector/[Anypoint MQ Connector in Anypoint Exchange]
