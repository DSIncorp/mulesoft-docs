= Custom Policy Development Reference

To develop a custom policy, you need a maven project having the following structure:

image::custom-policy-structure.png[]

Where:

* pom.xml meets the following requirements:
** groupId = organization Id.
** packaging = `mule-policy`. 
+
This value is a Mule custom value for policies provided by the `mule-maven-plugin`, so this plugin has to be present in the pom also.
+
* mule-artifact.json exists for the mule-maven-plugin. 
This is the same file you need for Mule applications.
+
* my-custom-policy.yaml exists to render the policy configuration UI. 
+
If this file is not provided, the policy won’t be able to be applied through API Platform’s UI.
* template.xml
+
The template represents the actual logic of the policy and Mule configuration that defines the policy behavior. 

== POM Configuration Example

The minimum required POM configuration is:

----
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">

   <modelVersion>4.0.0</modelVersion>

   <groupId>bbd37829-003c-4f20-8888-3181b24e3384</groupId>
   <artifactId>my-custom-policy</artifactId>
   <version>1.0.0-SNAPSHOT</version>

   <packaging>mule-policy</packaging>

   <properties>
       <mule.maven.plugin.version>3.0.0</mule.maven.plugin.version>
   </properties>

   <build>
       <plugins>
           <plugin>
               <groupId>org.mule.tools.maven</groupId>
               <artifactId>mule-maven-plugin</artifactId>
               <version>${mule.maven.plugin.version}</version>
               <extensions>true</extensions>
           </plugin>
       </plugins>
   </build>
</project>
----

== mule-artifact.json Example

----
{
 "name": "my-custom-policy-template",
 "minMuleVersion": "4.0.0",
 "requiredProduct": "MULE_EE",
 "classLoaderModelLoaderDescriptor": {
   "id": "mule",
   "attributes": {}
 },
 "bundleDescriptorLoader": {
   "id": "mule",
   "attributes": {
     "groupId": "bbd37829-003c-4f20-8888-3181b24e3384",
     "artifactId": "my-custom-policy",
     "version": "1.0.0-SNAPSHOT",
     "classifier": "mule-policy",
     "type": "jar"
   }
 }
}
----

== my-custom-policy.yaml Example

----
id: my-custom-policy
name: My Custom Policy
supportedPoliciesVersions: '>=v1'
description: The custom policy description
category: Custom
type: custom
resourceLevelSupported: true
standalone: true
requiredCharacteristics: []
providedCharacteristics:
 - Some Characteristic
configuration: []
----

== Common errors

## Unauthorized 401 during Policy Deployment

This error happens due to one of the following reasons:
* settings.xml does not contain the appropriate credentials.
* GroupId holding the Anypoint Organization Id is not correctly set up.
* GroupId is not the same on both `pom.xml` and `mule-artifact.json`.

## Artifact descriptor does not exists

This error is encountered when then pom.xml and mule-artifact.json have different classifiers defining the project.

### Sample mule-artifact.json
----
{
	"configs": [
		"template.xml"
	],
	"name": "my-policy",
	"minMuleVersion": "4.1.2",
	"requiredProduct": "MULE_EE",
	"classLoaderModelLoaderDescriptor": {
		"id": "mule",
		"attributes": {
			
		}
	},
	"bundleDescriptorLoader": {
		"id": "mule",
		"attributes": {
			"groupId": "orgid",
			"artifactId": "my-policy",
			"version": "1.0.0",
			"classifier": "mule-policy",
			"type": "jar"
		}
	}
}
----

#### Sample pom.xml
----
<groupId>4b8bdc4a-8b72-41c8-b08a-663004389f72</groupId>
<artifactId>my-policy</artifactId>
<version>1.0.0</version>
<packaging>mule-policy</packaging>

<name>my-policy</name>
----
OR
----
<plugin>
				<groupId>org.mule.tools.maven</groupId>
				<artifactId>mule-maven-plugin</artifactId>
				<version>${mule.maven.plugin.version}</version>
				<extensions>true</extensions>
				<configuration>
				<classifier>mule-application-template</classifier>
                </configuration>
			</plugin>
----

## A policy template artifact cannot export packages

This error is encountered when custom Java/Groovy code is used in the Policy.

### Solution

Package required libraries and the code into an SDK module and reference the module in a custom policy.
